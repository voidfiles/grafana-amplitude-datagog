{"version":3,"sources":["../../src/datasource.js"],"names":["AmplitudeDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","api_key","jsonData","secret_key","authdata","btoa","supportMetrics","q","_cached_metrics","_cached_props","_fetching_props","datasourceRequest","method","headers","then","response","status","message","title","eventName","when","_cached_tags","self","fetching_props","map","data","event","text","value","fetching_tags","myDate","format","from","to","target","numDays","diff","i","formatDate","e","uniquePropCount","query","params","points","each","series","row","val","x","dates","xValues","dateString","Date","getTime","alias","refId","zip","options","targets","filter","t","hide","all","getTarget","range","targetData","console","log"],"mappings":";;;;;;;;;AAAA;;;;;;;;IAEaA,mB,WAAAA,mB;AAEX,+BAAaC,gBAAb,EAA+BC,EAA/B,EAAmCC,UAAnC,EAA+CC,WAA/C,EAA4D;AAAA;;AAC1D,SAAKC,IAAL,GAAYJ,iBAAiBI,IAA7B;AACA,SAAKC,GAAL,GAAWL,iBAAiBK,GAA5B;AACA,SAAKC,IAAL,GAAYN,iBAAiBM,IAA7B;AACA,SAAKC,OAAL,GAAeP,iBAAiBQ,QAAjB,CAA0BD,OAAzC;AACA,SAAKE,UAAL,GAAkBT,iBAAiBQ,QAAjB,CAA0BC,UAA5C;AACA,SAAKC,QAAL,GAAgBC,KAAK,KAAKJ,OAAL,GAAe,GAAf,GAAqB,KAAKE,UAA/B,CAAhB;;AAEA,SAAKG,cAAL,GAAsB,IAAtB;AACA,SAAKC,CAAL,GAASZ,EAAT;AACA,SAAKC,UAAL,GAAkBA,UAAlB;AACA,SAAKC,WAAL,GAAmBA,WAAnB;AACA,SAAKW,eAAL,GAAuB,KAAvB;;AAEA,SAAKC,aAAL,GAAqB,EAArB;AACA,SAAKC,eAAL,GAAuB,EAAvB;AAED;;AAED;;;;;qCACiB;AACf,aAAO,KAAKd,UAAL,CAAgBe,iBAAhB,CAAkC;AACvCZ,aAAK,KAAKA,GAAL,GAAW,cADuB;AAEvCa,gBAAQ,KAF+B;AAGvCC,iBAAS;AACP,2BAAiB,WAAW,KAAKT;AAD1B;AAH8B,OAAlC,EAMJU,IANI,CAMC,UAASC,QAAT,EAAmB;AACzB,YAAIA,SAASC,MAAT,KAAoB,GAAxB,EAA6B;AAC3B,iBAAO;AACLA,oBAAQ,SADH;AAELC,qBAAS,wBAFJ;AAGLC,mBAAO;AAHF,WAAP;AAKD;AACF,OAdM,CAAP;AAeD;;;oCAEeC,S,EAAW;AACzB,UAAI,KAAKV,aAAL,CAAmBU,SAAnB,CAAJ,EAAmC;AACjC,eAAO,KAAKZ,CAAL,CAAOa,IAAP,CAAY,KAAKC,YAAL,CAAkBF,SAAlB,CAAZ,CAAP;AACD;;AAED,UAAI,KAAKT,eAAL,CAAqBS,SAArB,CAAJ,EAAqC;AACnC,eAAO,KAAKT,eAAL,CAAqBS,SAArB,CAAP;AACD;;AAED,UAAIG,OAAO,IAAX;AACA,WAAKC,cAAL,CAAoBJ,SAApB,IAAiC,KAAKvB,UAAL,CAAgBe,iBAAhB,CAAkC;AAC/DZ,aAAKuB,KAAKvB,GAAL,GAAW,cAD+C;AAE/Da,gBAAQ,KAFuD;AAG/DC,iBAAS;AACP,2BAAiB,WAAW,KAAKT;AAD1B;AAHsD,OAAlC,EAM9BU,IAN8B,CAMzB,UAASC,QAAT,EAAmB;AACvBO,aAAKD,YAAL,GAAoB,iBAAEG,GAAF,CAAMT,SAASU,IAAT,CAAcA,IAApB,EAA0B,UAAUC,KAAV,EAAiB;AAC7D,iBAAO;AACLC,kBAAMD,MAAM1B,IADP;AAEL4B,mBAAOF,MAAM1B;AAFR,WAAP;AAID,SALmB,CAApB;;AAOA,eAAOsB,KAAKD,YAAZ;AACH,OAfgC,CAAjC;;AAiBA,aAAO,KAAKQ,aAAZ;AAED;;;sCAEiB;AAChB,UAAI,KAAKR,YAAT,EAAuB;AACrB,eAAO,KAAKd,CAAL,CAAOa,IAAP,CAAY,KAAKC,YAAjB,CAAP;AACD;;AAED,UAAI,KAAKQ,aAAT,EAAwB;AACtB,eAAO,KAAKA,aAAZ;AACD;AACD,UAAIP,OAAO,IAAX;AACA,WAAKO,aAAL,GAAqB,KAAKjC,UAAL,CAAgBe,iBAAhB,CAAkC;AACnDZ,aAAKuB,KAAKvB,GAAL,GAAW,cADmC;AAEnDa,gBAAQ,KAF2C;AAGnDC,iBAAS;AACP,2BAAiB,WAAW,KAAKT;AAD1B;AAH0C,OAAlC,EAMlBU,IANkB,CAMb,UAASC,QAAT,EAAmB;AACvBO,aAAKD,YAAL,GAAoB,iBAAEG,GAAF,CAAMT,SAASU,IAAT,CAAcA,IAApB,EAA0B,UAAUC,KAAV,EAAiB;AAC7D,iBAAO;AACLC,kBAAMD,MAAM1B,IADP;AAEL4B,mBAAOF,MAAM1B;AAFR,WAAP;AAID,SALmB,CAApB;;AAOA,eAAOsB,KAAKD,YAAZ;AACH,OAfoB,CAArB;;AAiBA,aAAO,KAAKQ,aAAZ;AAED;;;+BAEUC,M,EAAQ;AACjB,aAAOA,OAAOC,MAAP,CAAc,UAAd,CAAP;AACD;;;8BAESC,I,EAAMC,E,EAAIC,M,EAAQ;AAC1B,UAAIC,UAAUF,GAAGG,IAAH,CAAQJ,IAAR,EAAc,MAAd,CAAd;AACA,UAAIK,IAAI,UAAR;;AAEA,UAAIF,WAAW,CAAf,EAAkB;AAChBE,YAAI,GAAJ;AACD,OAFD,MAEO,IAAIF,WAAW,EAAf,EAAmB;AACxBE,YAAI,IAAJ;AACD;AACD,UAAIL,OAAO,KAAKM,UAAL,CAAgBN,IAAhB,CAAX;AACA,UAAIC,KAAK,KAAKK,UAAL,CAAgBL,EAAhB,CAAT;AACA,UAAIM,IAAI,EAAC,cAAcL,OAAOR,KAAtB,EAAR;AACA,UAAIQ,OAAOM,eAAX,EAA4B;AAC1BD,UAAE,UAAF,IAAgB,CACZ;AACI,kBAAQ,OADZ;AAEI,mBAASL,OAAOM;AAFpB,SADY,CAAhB;AAMD;AACD,UAAIC,QAAQ;AACV,aAAKF,CADK;AAEV,aAAK,QAFK;AAGV,iBAASP,IAHC;AAIV,eAAOC,EAJG;AAKV,aAAKI;AALK,OAAZ;;AAQA,aAAO,KAAKzC,UAAL,CAAgBe,iBAAhB,CAAkC;AACvCZ,aAAK,KAAKA,GAAL,GAAW,sBADuB;AAEvC2C,gBAAQD,KAF+B;AAGvC7B,gBAAQ,KAH+B;AAIvCC,iBAAS;AACP,2BAAiB,WAAW,KAAKT;AAD1B;AAJ8B,OAAlC,EAOJU,IAPI,CAOC,UAAUC,QAAV,EAAoB;AAC1B,YAAI4B,MAAJ;AACA,YAAIT,OAAOM,eAAX,EAA4B;AAC1BG,mBAAS,EAAT;AACA,2BAAEC,IAAF,CAAO7B,SAASU,IAAT,CAAcA,IAAd,CAAmBoB,MAA1B,EAAkC,UAAUC,GAAV,EAAeT,CAAf,EAAkB;AAClD,6BAAEO,IAAF,CAAOE,GAAP,EAAY,UAAUC,GAAV,EAAeC,CAAf,EAAkB;AAC5B,kBAAI,CAACL,OAAOK,CAAP,CAAL,EAAgB;AACdL,uBAAOK,CAAP,IAAY,CAAZ;AACD;AACD,kBAAID,GAAJ,EAAS;AACPJ,uBAAOK,CAAP,KAAa,CAAb;AACD;AACF,aAPD;AAQD,WATD;AAUD,SAZD,MAYO;AACLL,mBAAS5B,SAASU,IAAT,CAAcA,IAAd,CAAmBoB,MAAnB,CAA0B,CAA1B,CAAT;AACD;AACD,YAAII,QAAQ,iBAAEzB,GAAF,CAAMT,SAASU,IAAT,CAAcA,IAAd,CAAmByB,OAAzB,EAAkC,UAAUC,UAAV,EAAsB;AAClE,iBAAO,IAAIC,IAAJ,CAASD,UAAT,EAAqBE,OAArB,EAAP;AACD,SAFW,CAAZ;;AAIA,eAAO;AACL,oBAAUnB,OAAOoB,KAAP,IAAgBpB,OAAOqB,KAD5B;AAEL,wBAAc,iBAAEC,GAAF,CAAMb,MAAN,EAAcM,KAAd;AAFT,SAAP;AAID,OAhCM,CAAP;AAiCD;;;0BAEKQ,O,EAAS;AACb,UAAIC,UAAUD,QAAQC,OAAR,CAAgBC,MAAhB,CAAuB,UAAUC,CAAV,EAAa;AAAE,eAAO,CAACA,EAAEC,IAAV;AAAiB,OAAvD,CAAd;AACA,UAAIvC,OAAO,IAAX;AACA,aAAO,KAAKf,CAAL,CAAOuD,GAAP,CAAW,iBAAEtC,GAAF,CAAMkC,OAAN,EAAe,UAAUxB,MAAV,EAAkB;AACjD,eAAOZ,KAAKyC,SAAL,CACLN,QAAQO,KAAR,CAAchC,IADT,EAELyB,QAAQO,KAAR,CAAc/B,EAFT,EAGLC,MAHK,CAAP;AAKD,OANiB,CAAX,EAMHpB,IANG,CAME,UAAUmD,UAAV,EAAsB;AAC7BC,gBAAQC,GAAR,CAAYF,UAAZ;AACA,eAAO;AACL,kBAAQA;AADH,SAAP;AAGD,OAXM,CAAP;AAYD","file":"datasource.js","sourcesContent":["import _ from 'lodash';\n\nexport class AmplitudeDatasource {\n\n  constructor (instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.api_key = instanceSettings.jsonData.api_key;\n    this.secret_key = instanceSettings.jsonData.secret_key;\n    this.authdata = btoa(this.api_key + ':' + this.secret_key);\n\n    this.supportMetrics = true;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this._cached_metrics = false;\n\n    this._cached_props = {};\n    this._fetching_props = {};\n\n  }\n\n  // Function to check Datasource health\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/events/list',\n      method: 'GET',\n      headers: {\n        'Authorization': 'Basic ' + this.authdata\n      },\n    }).then(function(response) {\n      if (response.status === 200) {\n        return {\n          status: \"success\",\n          message: \"Data source is working\",\n          title: \"Success\",\n        };\n      }\n    });\n  }\n\n  metricFindProps(eventName) {\n    if (this._cached_props[eventName]) {\n      return this.q.when(this._cached_tags[eventName]);\n    }\n\n    if (this._fetching_props[eventName]) {\n      return this._fetching_props[eventName];\n    }\n\n    var self = this;\n    this.fetching_props[eventName] = this.backendSrv.datasourceRequest({\n        url: self.url + '/events/list',\n        method: 'GET',\n        headers: {\n          'Authorization': 'Basic ' + this.authdata\n        },\n    }).then(function(response) {\n        self._cached_tags = _.map(response.data.data, function (event) {\n          return {\n            text: event.name,\n            value: event.name,\n          };\n        });\n\n        return self._cached_tags;\n    });\n\n    return this.fetching_tags;\n\n  }\n\n  metricFindQuery() {\n    if (this._cached_tags) {\n      return this.q.when(this._cached_tags);\n    }\n\n    if (this.fetching_tags) {\n      return this.fetching_tags;\n    }\n    var self = this;\n    this.fetching_tags = this.backendSrv.datasourceRequest({\n        url: self.url + '/events/list',\n        method: 'GET',\n        headers: {\n          'Authorization': 'Basic ' + this.authdata\n        },\n    }).then(function(response) {\n        self._cached_tags = _.map(response.data.data, function (event) {\n          return {\n            text: event.name,\n            value: event.name,\n          };\n        });\n\n        return self._cached_tags;\n    });\n\n    return this.fetching_tags;\n\n  }\n\n  formatDate(myDate) {\n    return myDate.format('YYYYMMDD');\n  }\n\n  getTarget(from, to, target) {\n    var numDays = to.diff(from, 'days');\n    var i = \"-3600000\";\n\n    if (numDays >= 6) {\n      i = '1';\n    } else if (numDays >= 60) {\n      i = '30';\n    }\n    var from = this.formatDate(from);\n    var to = this.formatDate(to);\n    var e = {\"event_type\": target.event};\n    if (target.uniquePropCount) {\n      e[\"group_by\"] = [\n          {\n              \"type\": \"event\",\n              \"value\": target.uniquePropCount,\n          }\n      ];\n    }\n    var query = {\n      'e': e,\n      'm': 'totals',\n      'start': from,\n      'end': to,\n      'i': i,\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/events/segmentation',\n      params: query,\n      method: 'GET',\n      headers: {\n        'Authorization': 'Basic ' + this.authdata\n      },\n    }).then(function (response) {\n      var points;\n      if (target.uniquePropCount) {\n        points = [];\n        _.each(response.data.data.series, function (row, i) {\n          _.each(row, function (val, x) {\n            if (!points[x]) {\n              points[x] = 0;\n            }\n            if (val) {\n              points[x] += 1;\n            }\n          });\n        });\n      } else {\n        points = response.data.data.series[0];\n      }\n      var dates = _.map(response.data.data.xValues, function (dateString) {\n        return new Date(dateString).getTime();\n      });\n\n      return {\n        \"target\": target.alias || target.refId,\n        \"datapoints\": _.zip(points, dates),\n      };\n    });\n  }\n\n  query(options) {\n    var targets = options.targets.filter(function (t) { return !t.hide; });\n    var self = this;\n    return this.q.all(_.map(targets, function (target) {\n      return self.getTarget(\n        options.range.from,\n        options.range.to,\n        target\n      );\n    })).then(function (targetData) {\n      console.log(targetData);\n      return {\n        'data': targetData\n      }\n    });\n  }\n\n}\n"]}