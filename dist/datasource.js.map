{"version":3,"sources":["../src/datasource.js"],"names":["_","AmplitudeDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","api_key","jsonData","secret_key","authdata","btoa","supportMetrics","q","_cached_metrics","_cached_props","_fetching_props","datasourceRequest","method","headers","then","response","status","message","title","eventName","when","_cached_tags","self","fetching_props","map","data","event","text","value","fetching_tags","myDate","format","from","to","target","numDays","diff","i","formatDate","e","uniquePropCount","query","params","points","each","series","row","val","x","dates","xValues","dateString","Date","getTime","alias","refId","zip","options","targets","filter","t","hide","all","getTarget","range","targetData","console","log"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\n\nexport class AmplitudeDatasource {\n\n  constructor (instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.api_key = instanceSettings.jsonData.api_key;\n    this.secret_key = instanceSettings.jsonData.secret_key;\n    this.authdata = btoa(this.api_key + ':' + this.secret_key);\n\n    this.supportMetrics = true;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this._cached_metrics = false;\n\n    this._cached_props = {};\n    this._fetching_props = {};\n\n  }\n\n  // Function to check Datasource health\n  testDatasource() {\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/events/list',\n      method: 'GET',\n      headers: {\n        'Authorization': 'Basic ' + this.authdata\n      },\n    }).then(function(response) {\n      if (response.status === 200) {\n        return {\n          status: \"success\",\n          message: \"Data source is working\",\n          title: \"Success\",\n        };\n      }\n    });\n  }\n\n  metricFindProps(eventName) {\n    if (this._cached_props[eventName]) {\n      return this.q.when(this._cached_tags[eventName]);\n    }\n\n    if (this._fetching_props[eventName]) {\n      return this._fetching_props[eventName];\n    }\n\n    var self = this;\n    this.fetching_props[eventName] = this.backendSrv.datasourceRequest({\n        url: self.url + '/events/list',\n        method: 'GET',\n        headers: {\n          'Authorization': 'Basic ' + this.authdata\n        },\n    }).then(function(response) {\n        self._cached_tags = _.map(response.data.data, function (event) {\n          return {\n            text: event.name,\n            value: event.name,\n          };\n        });\n\n        return self._cached_tags;\n    });\n\n    return this.fetching_tags;\n\n  }\n\n  metricFindQuery() {\n    if (this._cached_tags) {\n      return this.q.when(this._cached_tags);\n    }\n\n    if (this.fetching_tags) {\n      return this.fetching_tags;\n    }\n    var self = this;\n    this.fetching_tags = this.backendSrv.datasourceRequest({\n        url: self.url + '/events/list',\n        method: 'GET',\n        headers: {\n          'Authorization': 'Basic ' + this.authdata\n        },\n    }).then(function(response) {\n        self._cached_tags = _.map(response.data.data, function (event) {\n          return {\n            text: event.name,\n            value: event.name,\n          };\n        });\n\n        return self._cached_tags;\n    });\n\n    return this.fetching_tags;\n\n  }\n\n  formatDate(myDate) {\n    return myDate.format('YYYYMMDD');\n  }\n\n  getTarget(from, to, target) {\n    var numDays = to.diff(from, 'days');\n    var i = \"-3600000\";\n\n    if (numDays >= 6) {\n      i = '1';\n    } else if (numDays >= 60) {\n      i = '30';\n    }\n    var from = this.formatDate(from);\n    var to = this.formatDate(to);\n    var e = {\"event_type\": target.event};\n    if (target.uniquePropCount) {\n      e[\"group_by\"] = [\n          {\n              \"type\": \"event\",\n              \"value\": target.uniquePropCount,\n          }\n      ];\n    }\n    var query = {\n      'e': e,\n      'm': 'totals',\n      'start': from,\n      'end': to,\n      'i': i,\n    };\n\n    return this.backendSrv.datasourceRequest({\n      url: this.url + '/events/segmentation',\n      params: query,\n      method: 'GET',\n      headers: {\n        'Authorization': 'Basic ' + this.authdata\n      },\n    }).then(function (response) {\n      var points;\n      if (target.uniquePropCount) {\n        points = [];\n        _.each(response.data.data.series, function (row, i) {\n          _.each(row, function (val, x) {\n            if (!points[x]) {\n              points[x] = 0;\n            }\n            if (val) {\n              points[x] += 1;\n            }\n          });\n        });\n      } else {\n        points = response.data.data.series[0];\n      }\n      var dates = _.map(response.data.data.xValues, function (dateString) {\n        return new Date(dateString).getTime();\n      });\n\n      return {\n        \"target\": target.alias || target.refId,\n        \"datapoints\": _.zip(points, dates),\n      };\n    });\n  }\n\n  query(options) {\n    var targets = options.targets.filter(function (t) { return !t.hide; });\n    var self = this;\n    return this.q.all(_.map(targets, function (target) {\n      return self.getTarget(\n        options.range.from,\n        options.range.to,\n        target\n      );\n    })).then(function (targetData) {\n      console.log(targetData);\n      return {\n        'data': targetData\n      }\n    });\n  }\n\n}\n"]}